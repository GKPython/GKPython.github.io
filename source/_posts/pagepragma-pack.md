---
title: 由pragma pack引发的一场灾难
date: 2020-06-05 14:30:44
tags: 技术
---

先大概说下背景。

1) 已有一个linux程序要运行到一个配置比较底的设备上。程序大小为15M。

2)新设备上要求程序大小。程序的形式为so，通过结构外部调用。

对程序大小进行缩减，主要方案：
1）减少不必要的第三方依赖；
2）将用不到的代码完全删除掉。
这里主要说下第二条，经过1天半修改了大概60多个文件，边改边测，一切OK了，然后就提交了。

第二天测试的时候，有个分支因为配置关系没有走到，重新配置测试发现莫名其妙死机，看堆栈只知道是内存越界，然后就开始了灾难般的内存越界调查。
开始使用Debug查了半天也未能定位，最后还是使用老办法，对之前提交的60多个文件回归，一行一行的删，一行一行测。
看遍了数万行代码，调试了2天，最后发现：删除无用代码的时候多删了一行pragma pack。

pragma pack：程序编译器对结构的存储的特殊处理确实提高CPU存储变量的速度，但是有时候也带来了一些麻烦，我们也屏蔽掉变量默认的对齐方式，自己可以设定变量的对齐方式。
加这个是为了按照自己的方式对齐内存。用法为：pragma pack（n），按n个字节对齐，pragma pack（）表示恢复默认对齐方式，二者必须配对使用。

教训及反思：
1）必须保证程序配置的正确性，小批量提交；
2）这个之前语法没用过，整个工程里也用的很少，所以删减代码的使用因为紧靠无用代码，警惕性不高就删除了，所以得加强学习；
3）编译器编译未对此类问题进行警告、或错误提示，看来编译器还有较大改进空间。
